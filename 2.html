<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rezervasyon Kontrol</title>
  <style>
    body {
      background: #0d0d1a;
      color: white;
      font-family: sans-serif;
      padding: 20px;
    }
    h1 { color: #e6f0ff; text-align: center; }
    .card {
      background: #101020;
      border: 1px solid #1f1f3d;
      padding: 20px;
      margin: 20px auto;
      max-width: 700px;
      border-radius: 10px;
    }
    input, select, button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    button {
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #00ccaa; }
    .result.success { color: #00ff00; }
    .result.wrongcrs { color: #ff5555; }
    .result.multiple { color: #00ffff; }
    .result.none { color: #aaaaaa; }
    .ocr-preview {
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 0.9rem;
      background: #1a1a3d;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Rezervasyon Kontrol Sistemi</h1>
  <div class="card">
    <label>PDF Dosyaları</label>
    <input type="file" id="pdfInput" accept="application/pdf" multiple />
    <label>Excel Dosyası (.xlsx veya .xls)</label>
    <input type="file" id="excelInput" accept=".xlsx,.xls" />
    <label>OCR Dili</label>
    <select id="ocrLang">
      <option value="tur">Türkçe</option>
      <option value="eng">İngilizce</option>
      <option value="deu">Almanca</option>
    </select>
    <button onclick="handleApply()">UYGULA</button>
  </div>
  <div class="card">
    <h3>OCR Önizleme</h3>
    <div id="ocrPreview" class="ocr-preview">Henüz bir önizleme yok.</div>
  </div>
  <div class="card">
    <h3>Sonuçlar</h3>
    <div id="results">Henüz bir işlem yapılmadı.</div>
  </div>

  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    function extractFieldsFromText(text) {
      let fields = { isim: '', crs: '', giris: '', cikis: '' };
      const tokens = text.split(/\s+/);
      const names = [], dates = [], times = [], codes = [];

      for (let i = 0; i < tokens.length; i++) {
        const t = tokens[i];
        if (/\d{2}[./-]\d{2}[./-]\d{4}/.test(t)) {
          const next = tokens[i + 1] || '';
          if (/\d{1,2}:\d{2}/.test(next)) { dates.push(`${t} ${next}`); i++; }
          else { dates.push(t); }
        } else if (/\d{1,2}:\d{2}/.test(t)) {
          times.push(t);
        } else if (/^[A-Z]{2,}\d+/.test(t)) {
          codes.push(t);
        } else if (/^[A-ZÇĞİÖŞÜ][a-zçğıöşü]+$/.test(t)) {
          names.push(t);
        }
      }

      if (names.length >= 2) fields.isim = names.slice(0, 2).join(' ');
      if (dates.length >= 1) fields.giris = dates[0];
      if (dates.length >= 2) fields.cikis = dates[1];
      if (codes.length >= 1) fields.crs = codes[0];

      return fields;
    }

    async function extractPdfText(file, lang) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;
        const { data: { text } } = await Tesseract.recognize(canvas, lang);
        fullText += text + " ";
      }

      return extractFieldsFromText(fullText);
    }

    function readExcel(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const workbook = XLSX.read(e.target.result, { type: "binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { header: "A" });
          resolve(data);
        };
        reader.readAsBinaryString(file);
      });
    }

    function compare(extracted, row) {
      const isimScore = levenshteinSimilarity((row["F"] || '').toLowerCase(), extracted.isim.toLowerCase());
      const crsMatch = extracted.crs === (row["Z"] || '').toString();
      const girisMatch = extracted.giris === (row["G"] || '').toString();
      const cikisMatch = extracted.cikis === (row["H"] || '').toString();
      const status = isimScore > 0.85 && crsMatch && girisMatch && cikisMatch ? "success" : isimScore > 0.85 ? "wrongcrs" : "none";
      return status;
    }

    function levenshteinSimilarity(a, b) {
      const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i++) dp[i][0] = i;
      for (let j = 0; j <= b.length; j++) dp[0][j] = j;
      for (let i = 1; i <= a.length; i++) {
        for (let j = 1; j <= b.length; j++) {
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + (a[i - 1] === b[j - 1] ? 0 : 1)
          );
        }
      }
      const distance = dp[a.length][b.length];
      return 1 - distance / Math.max(a.length, b.length);
    }

    async function handleApply() {
      const pdfFiles = document.getElementById("pdfInput").files;
      const excelFile = document.getElementById("excelInput").files[0];
      const lang = document.getElementById("ocrLang").value;
      if (!pdfFiles.length || !excelFile) {
        alert("Lütfen PDF ve Excel dosyasını seçin.");
        return;
      }

      const excelData = await readExcel(excelFile);
      const results = document.getElementById("results");
      results.innerHTML = "";

      for (const file of pdfFiles) {
        const extracted = await extractPdfText(file, lang);
        document.getElementById("ocrPreview").innerText = `İsim: ${extracted.isim}\nCRS: ${extracted.crs}\nGiriş: ${extracted.giris}\nÇıkış: ${extracted.cikis}`;

        let matchFound = false;
        for (const row of excelData) {
          const status = compare(extracted, row);
          if (status !== "none") {
            const div = document.createElement("div");
            div.className = `result ${status}`;
            div.textContent = `${file.name} → ${status.toUpperCase()} (Excel: ${row["F"]})`;
            results.appendChild(div);
            matchFound = true;
            break;
          }
        }

        if (!matchFound) {
          const div = document.createElement("div");
          div.className = "result none";
          div.textContent = `${file.name} → Eşleşme bulunamadı.`;
          results.appendChild(div);
        }
      }
    }
  </script>
</body>
</html>
